<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Set Panel Password - OpsLink Hosting</title>
<link rel="icon" href="assets/hero.png" />
<script src="js/ui-alerts.js" defer></script>
<style>
  /* Include all your existing styles here (same as original) */
</style>
</head>
<body>

<header class="nav">
  <div class="nav-inner">
    <div class="logo">OpsLink<span>Hosting</span></div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="website-hosting.html?filter=all">Website Hosting</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="support.html">Support</a>
      <a href="auth-login.html" class="login-btn" id="loginBtn">Login</a>
      <div id="userWrapper" style="position: relative; display: inline-block;">
        <img id="userIcon" src="assets/user-circle.png" width="35" style="border-radius:50%; cursor:pointer;">
        <div id="userDropdown">
          <a href="account.html">Account Settings</a>
          <a href="invoice.html">Subscriptions</a>
          <a href="#" id="logoutBtn">Logout</a>
        </div>
      </div>
    </div>
  </div>
</header>

<section class="hero">
  <div class="card" style="max-width:400px; margin:auto;">
    <h2>Set Your Pterodactyl Panel Password</h2>
    <form id="setPasswordForm">
      <input type="password" name="password" placeholder="New Password" required minlength="8" autocomplete="new-password" style="width:100%; padding:12px; margin:10px 0; border-radius:8px;">
      <input type="password" name="confirmPassword" placeholder="Confirm Password" required minlength="8" autocomplete="new-password" style="width:100%; padding:12px; margin:10px 0; border-radius:8px;">
      <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">Set Password</button>
    </form>
    <p style="margin-top:10px;">Already set? <a href="account.html" style="color:#4e8cff;">Go to Account</a></p>
  </div>
</section>

<footer>
© 2025 OpsLink Systems Network — All Rights Reserved.<br>
Visit <a href="https://opslinksystems.xyz">OpsLink Systems</a> for more.
</footer>

<script>
async function uiAlert(message, title="Notice") { alert(`${title}: ${message}`); }

// ---------------- AUTH ----------------
let token = localStorage.getItem("token");
const urlParams = new URLSearchParams(window.location.search);
const guestUserId = urlParams.get("guestUserId");

// Auto-login guest users
if(!token && guestUserId){
  try {
    const res = await fetch(`/api/guest-token/${guestUserId}`);
    const data = await res.json();
    if(data.success){
      token = data.token;
      localStorage.setItem("token", token);
    } else {
      uiAlert("Failed to authenticate. Please login.", "Auth Error");
      window.location.href = "/auth-login.html";
    }
  } catch(err){
    console.error(err);
    window.location.href = "/auth-login.html";
  }
}

if(!token){
  uiAlert("You must be logged in to set a password.", "Authentication Required");
  window.location.href = "/auth-login.html";
}

// ---------------- DROPDOWN & LOGOUT ----------------
const userIcon = document.getElementById("userIcon");
const userDropdown = document.getElementById("userDropdown");
userIcon.addEventListener("click", e=>{
  e.stopPropagation();
  userDropdown.classList.toggle("show");
});
document.addEventListener("click", ()=>userDropdown.classList.remove("show"));
document.getElementById("logoutBtn")?.addEventListener("click", ()=>{
  localStorage.removeItem("token");
  location.reload();
});

// ---------------- SET PASSWORD FORM ----------------
const form = document.getElementById("setPasswordForm");
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const password = form.password.value;
  const confirmPassword = form.confirmPassword.value;
  if(password !== confirmPassword) return uiAlert("Passwords do not match.", "Notice");

  try {
    const res = await fetch("/api/set-panel-password", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if(data.success){
      uiAlert("Password set successfully!", "Success");
      window.location.href = "/account.html";
    } else {
      uiAlert(data.message || "Failed to set password.", "Error");
    }
  } catch(err){
    console.error(err);
    uiAlert("Error setting password.", "Error");
  }
});
</script>

</body>
</html>
